{% extends "wagtailadmin/base.html" %}
{% load image_tags ellipsistrim %}

{% block titletag %}Images{% endblock %}
{% block bodyclass %}menu-images{% endblock %}
{% block extra_js %}
    <script>
        $('#id_q').on('input', function() {
            clearTimeout($.data(this, 'timer'));
            var wait = setTimeout(search, 200);
            $(this).data('timer', wait);
        });
        $('a.suggested-tag').click(function() {
            $('#id_q').val($(this).text());
            search();
            return false;
        })

        // These variables keep track of ajax requests to prevent an older request from replacing a new one
        var search_current_index = 0;
        var search_next_index = 0;

        function search () {
            search_next_index++;
            var index = search_next_index;
            $.ajax({
                url: "{% url 'wagtailimages_index' %}",
                data: {q: $('#id_q').val()},
                success: function(data, status) {
                    if (index > search_current_index) {
                        search_current_index = index;
                        $('#image-results').html(data);
                    }
                },
            });
        };
    </script>
{% endblock %}

{% block content %}
    <header class="nice-padding">
        <div class="row row-flush">
            <div class="left col9">
                <h1>Images</h1>
            </div>
            <div class="right col3">
                <a href="{% url 'wagtailimages_add_image' %}" class="button bicolor icon icon-plus">Add an image</a>
            </div>
        </div>
    </header>

    <form class="search-bar full-width nice-padding" action="{% url 'wagtailimages_index' %}" method="get">
        <ul class="fields">
            {% for field in form %}
                {% include "wagtailadmin/shared/field_as_li.html" with field=field %}
            {% endfor %}
            <li class="submit"><input type="submit" value="Search" /></li>
            {% if popular_tags %}
                <li class="taglist">
                    <h3>Popular tags</h3>
                    {% for tag in popular_tags %}
                        <a class="suggested-tag tag" href="{% url 'wagtailimages_search_image' %}?q={{ tag.name|urlencode }}">{{ tag.name }}</a>
                    {% endfor %}
                </li>
            {% endif %}
        </ul>
    </form>

    <div class="nice-padding">
        <div id="image-results">
            {% include "wagtailimages/images/results.html" %}
        </div>
    </div>
{% endblock %}
